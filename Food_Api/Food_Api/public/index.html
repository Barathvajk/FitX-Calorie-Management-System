<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Agdasima:wght@700&family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <title>Food Search</title>
    <style>
        body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        font-size: 15px;
        position: relative;
        }


        .container {
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            height: 100vh;
        }

        h1 {
            text-align: center;
        }

        form {
            text-align: center;
            margin-bottom: 20px;
        }

        input[type="text"],
        input[type="number"],
        button {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
        }

        button {
            background-color: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            opacity: 0.8;
        }
        #foodDetails {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .food {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 20px;
        margin: 10px;
        max-width: 300px;
      }

        #progressContainer {
            text-align: center;
            margin-top: 20px;
        }

        progress {
            width: 300px;
            height: 20px;
            margin-bottom: 10px;
            appearance: none;
            border: none;
            background-color: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
        }

        progress::-webkit-progress-bar {
            background-color: #f3f3f3;
            border-radius: 10px;
        }

        progress::-webkit-progress-value {
            background: linear-gradient(to right, #4caf50, #4caf50);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        progress.exceeded::-webkit-progress-value {
            background: linear-gradient(to right, #ff0000, #ff0000);
        }

        progress::-moz-progress-bar {
            background-color: #4caf50;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        #remainingCalories {
            font-size: 18px;
        }

        .popup {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
        }
   

   header {
    text-align: center;
    background-color:black;
    padding: 20px 0;
    margin-bottom: 20px;

    }

      header h1 {
        color: #fff;
        margin: 0;
      }
      
   
        #dailyGoalContainer {
            text-align: center;
            margin-bottom: 20px;
            margin-right:50px;
        }

        #dailyGoal {
            padding: 10px;
            font-size: 16px;
        }
        .hlink {
          position:fixed;
          bottom: 0;
          left: 0;
          width: 100%; /* Stretch the link across the entire width of the viewport */
          background-color: #ffffff; /* Adjust background color as needed */
          padding: 10px; /* Adjust padding as needed */
          text-align: center; /* Adjust border properties as needed */
        }
        nav {
        background-color:black;
        padding: 10px 0;
        text-align: center;
      }

      nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      nav li {
        display: inline;
        margin-right: 20px;
      }

      nav a {
        color: #fff;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      nav a:hover {
      color: #0f0;
    }
    </style>
</head>
<body>
  <header>
    <h1>FIT<span style="color:#0f0">X</span></h1>
    </header>
    <nav>
      <ul>
        <li><a class="active" href="/home">Home</a></li>
        <li><a href="http://localhost:5000/bmi">BMI Calculator</a></li>
        <li><a href="http://localhost:5000/bodyfat">Body Fat Calculator</a></li>
        <li><a href="http://localhost:5000/calorie">BMR Calculator</a></li>
        <li><a href="http://localhost:3000">Food Database</a></li>
        <li><a href="http://localhost:3000/insight.html">Insight</a></li>
        <li><a href="http://localhost:5000/about">About us</a></li>
        <li><a href="/">Log Out</a></li>
      </ul>
    </nav><br><br>
    <div class="container">
      <h1>Food Search</h1>
    <form id="searchForm" action="/addFood" method="POST">
      <input type="text" id="searchInput" name="search" placeholder="Search for a food" />
      <button type="submit">Search</button>
    </form>
    <div id="foodDetails"></div>
     <div id="dailyGoalContainer">
        <label for="dailyGoal">Enter Daily Goal:</label><br>
        <input type="number" id="dailyGoal" name="dailyGoal" placeholder="Enter daily goal in kcal">
    </div>
    <div id="progressContainer">
        <h2>Progress</h2>
        <progress id="calorieProgress" value="0" max="100"></progress>
        <p id="remainingCalories"></p>
        <br /><br />
    </div>
   
</div>
<div class="popup" id="popupContainer">
  <div class="popup-content">
      <h2>Add Food Details</h2>
      <p id="foodNamePopup"></p> <!-- Display the food name here -->
      <label for="servingQuantity">Serving Quantity:</label><br />
      <input type="number" id="servingQuantity" min="1" value="1" /><br /><br />
      <label for="mealName">Meal Name:</label><br />
      <select id="mealName">
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="snacks">Snacks</option>
      </select><br /><br />
      <button id="addpopupbtn">Add</button>
      <button id="closePopupBtn">Close</button>
  </div>
</div>

</div>
<div class="hlink">
<a href="/insight.html">Go to Food Insight</a>
</div>
    <script>
      function updateCalorieValue() {
        // Update totalCalories when serving quantity changes
        const servingQuantity = parseFloat(document.getElementById("servingQuantity").value);
        const caloriePerServing = parseFloat(document.getElementById("foodDetails").dataset.calories);
        const totalCalories = servingQuantity * caloriePerServing;
        document.getElementById("food.calories").textContent = `Total Calories: ${totalCalories}`;
        
        // Call updateProgress to update progress bar when serving quantity changes
        updateProgress(totalCalories);
    }

        // Add event listener to the serving quantity input field
        document.getElementById("servingQuantity").addEventListener("input", updateCalorieValue);



        document.getElementById("addpopupbtn").addEventListener("click", () => {
    const servingQuantity = parseFloat(
        document.getElementById("servingQuantity").value
    );
    const mealName = document.getElementById("mealName").value;
    const foodCalories = parseFloat(document.querySelector(".addButton").dataset.calories);
    const protein = parseFloat(document.querySelector(".addButton").dataset.protein);
    const fat = parseFloat(document.querySelector(".addButton").dataset.fat);
    const carbs = parseFloat(document.querySelector(".addButton").dataset.carbs);
    const genericFoodName = document.querySelector(".addButton").dataset.genericfoodname;
    const specificFoodName = document.querySelector(".addButton").dataset.foodname;
    const foodName = specificFoodName ? specificFoodName : genericFoodName;

    // Send data to server
    fetch("/addFood", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            foodName: foodName,
            calories: foodCalories * servingQuantity,
            protein: protein * servingQuantity,
            fat: fat * servingQuantity,
            carbs: carbs * servingQuantity,
            mealName: mealName,
            servingQuantity: servingQuantity,
        }),
    })
    .then((response) => response.json())
    .then((data) => {
        if (data.success) {
            alert("Food successfully stored in the database.");
        } else {
            alert("Failed to store food in the database.");
        }
    })
    .catch((error) => {
        console.error("Error:", error);
        alert("An error occurred while processing your request.");
    });

    // Hide the pop-up container after adding food details
    const popup = document.getElementById("popupContainer");
    popup.style.display = "none";
    });
      // Load total calories from cookie if available
      let totalCalories = 0;
      let dailyGoal=0;

      document
        .getElementById("searchForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const searchValue = document.getElementById("searchInput").value;
          if (searchValue.trim() === "") {
            alert("Please enter a valid food name.");
            return; // Stop further execution
          }
          const response = await fetch("/search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ search: searchValue }),
          });
          const data = await response.json();
          displayFoodDetails(data);
        });

      document
        .getElementById("closePopupBtn")
        .addEventListener("click", function () {
          const popup = document.getElementById("popupContainer");
          popup.style.display = "none";
        });

        function displayFoodDetails(foods) {
    const foodDetailsDiv = document.getElementById("foodDetails");
    foodDetailsDiv.innerHTML = "";
    if (foods.length === 0) {
        foodDetailsDiv.innerHTML = "No matching foods found.";
    } else {
        foods.forEach((food) => {
            const foodDetails = `
                <div class="food">
                    <h2>${food.foodname}</h2>
                    <p>Calories: ${food.calories}</p>
                    <p>Protein: ${food.protein}</p>
                    <p>Fat: ${food.fat}</p>
                    <p>Carbs: ${food.carbs}</p>
                    <button class="addButton" 
                            data-calories="${food.calories}" 
                            data-protein="${food.protein}" 
                            data-fat="${food.fat}" 
                            data-carbs="${food.carbs}" 
                            data-genericfoodname="${food.foodname}" 
                            data-foodname="${food.specificname || ''}">Add</button>
                </div>
            `;
            foodDetailsDiv.innerHTML += foodDetails;
        });
    }

        // Attach event listeners to "Add" buttons
            const addButtonList = document.querySelectorAll(".addButton");
            addButtonList.forEach((button) => {

           // Inside the event listener for "Add" buttons
button.addEventListener("click", function () {
    const popup = document.getElementById("popupContainer");
    popup.style.display = "flex";
    const servingQuantity = parseFloat(document.getElementById("servingQuantity").value);
    const mealName = document.getElementById("mealName").value;
    const calories = parseFloat(this.dataset.calories) * servingQuantity;
    const protein = parseFloat(this.dataset.protein) * servingQuantity;
    const fat = parseFloat(this.dataset.fat) * servingQuantity;
    const carbs = parseFloat(this.dataset.carbs) * servingQuantity;
    const foodName = this.dataset.foodname || this.dataset.genericfoodname; // Use specific food name if available, else use generic food name

    // Update the food name displayed in the pop-up container
    document.getElementById("foodNamePopup").textContent = `Food Name: ${foodName}`;

    // Update the progress only after clicking the "Add" button in the pop-up
    document.getElementById("addpopupbtn").addEventListener("click", () => {
        updateProgress(
            calories,
            protein,
            fat,
            carbs,
            mealName,
            foodName // Pass both mealName and foodName
        );
        popup.style.display = "none"; // Hide the pop-up container after adding food details
    });
});

    });
}

function updateProgress(
    calories,
    protein,
    fat,
    carbs,
    mealName,
    foodName
  ) {
    // Calculate remaining calories before adding the new serving
    const remainingCaloriesBefore = dailyGoal - totalCalories;

    // Deduct the calories of previously added servings of the same food
    const existingFoodItems = document.querySelectorAll(`#${mealName}Table .food`);
    existingFoodItems.forEach((foodItem) => {
      if (foodItem.querySelector("h3").textContent.includes(foodName)) {
        const existingCalories = parseFloat(foodItem.querySelector("p:nth-child(2)").textContent.split(": ")[1]);
        totalCalories -= existingCalories;
      }
    });

    // Calculate total calories to add considering serving quantity
    const servingQuantity = parseFloat(document.getElementById("servingQuantity").value);
    const totalCaloriesToAdd = calories * servingQuantity;

    // Add the total calories to the total
    totalCalories += totalCaloriesToAdd;

    // Store the updated total calories in local storage
    localStorage.setItem("totalCalories", totalCalories);

    // Calculate remaining calories after adding the new serving
    const remainingCaloriesAfter = dailyGoal - totalCalories;

    // Update the width of the progress bar and the text
    const progressBar = document.getElementById("calorieProgress");
    const percentage = (totalCalories / dailyGoal) * 100;
    const width = percentage > 100 ? 100 : percentage;
    progressBar.value = width;

    // Update remaining calories
    const remainingCaloriesElement = document.getElementById("remainingCalories");
    remainingCaloriesElement.textContent = remainingCaloriesAfter >= 0 ? `Remaining Calories: ${remainingCaloriesAfter.toFixed(2)} kcal` : `Exceeded Goal by: ${Math.abs(remainingCaloriesAfter).toFixed(2)} kcal`;

    // Change progress bar color if goal exceeded
    if (totalCalories > dailyGoal) {
      progressBar.classList.add("exceeded");
    } else {
      progressBar.classList.remove("exceeded");
    }

    // Add food details to the respective meal table
    const mealTable = document.getElementById(`${mealName}Table`);
    const existingFood = mealTable.querySelector(`h3:contains('${mealName} - ${foodName}')`);
    if (!existingFood) {
      const foodDetails = `
        <div class="food">
          <h3>${mealName} - ${foodName}</h3>
          <p>Calories: ${totalCaloriesToAdd}</p>
          <p>Protein: ${protein}</p>
          <p>Fat: ${fat}</p>
          <p>Carbs: ${carbs}</p>
        </div>
      `;
      mealTable.innerHTML += foodDetails;
    }
  }
      
  document.getElementById("dailyGoal").addEventListener("input", function () {
    dailyGoal = parseFloat(document.getElementById("dailyGoal").value) || 0;
    updateProgress(0);  // Default value is 2000 kcal

    // Update the progress bar based on the user's input
    const progressBar = document.getElementById("calorieProgress");
    const percentage = (totalCalories / dailyGoal) * 100;
    progressBar.value = percentage > 100 ? 100 : percentage;
    progressBar.value = width;

    // Update remaining calories
    const remainingCalories = dailyGoal - totalCalories;
    const remainingCaloriesElement = document.getElementById("remainingCalories");
    remainingCaloriesElement.textContent = remainingCalories >= 0 ? `Remaining Calories: ${remainingCalories.toFixed(2)} kcal` : `Exceeded Goal by: ${Math.abs(remainingCalories).toFixed(2)} kcal`;
  });
    // Function to update the daily goal and store it in local storage
    function updateDailyGoal() {
        dailyGoal = parseFloat(document.getElementById("dailyGoal").value) || 0;
        localStorage.setItem("dailyGoal", dailyGoal);
        updateProgress(0); // Update progress with the new goal
    }

    document.getElementById("dailyGoal").addEventListener("input", updateDailyGoal);

    window.addEventListener("load", function () {
        // Retrieve the daily goal from local storage
        const storedGoal = localStorage.getItem("dailyGoal");
        // If the storedGoal is not null (meaning it's set), update the input field with the stored value
        if (storedGoal !== null) {
            document.getElementById("dailyGoal").value = storedGoal;
            // Also, update the dailyGoal variable with the stored value
            dailyGoal = parseFloat(storedGoal);
            // Update progress with the stored goal
            updateProgress(0);
        }
    });
    let addedFoodItems = [];

    // Function to update the added food items and store them in local storage
    function updateAddedFoodItems(foodDetails) {
        addedFoodItems.push(foodDetails);
        localStorage.setItem("addedFoodItems", JSON.stringify(addedFoodItems));
        // Update the progress bar with the new food details
        updateProgress(foodDetails.calories);
    }

    // Function to retrieve the added food items from local storage on page load
    window.addEventListener("load", function () {
        // Retrieve the added food items from local storage
        const storedItems = localStorage.getItem("addedFoodItems");
        // If storedItems is not null (meaning it's set), update the addedFoodItems array with the stored items
        if (storedItems !== null) {
            addedFoodItems = JSON.parse(storedItems);
            // Iterate over the stored items and update the progress bar with their calories
            addedFoodItems.forEach(function (item) {
                updateProgress(item.calories);
            });
        }
    });
    </script>
  </body>
</html>